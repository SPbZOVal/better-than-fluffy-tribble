name: Build and Test

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [ main, release ]

jobs:
  check-build-success:
    name: Check Build Success
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Build succeeded
        run: echo "Build workflow completed successfully"

  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: check-build-success

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential default-jre

    - name: Configure and Build with Tests
      run: |
        mkdir build
        cd build
        cmake .. -DBUILD_TESTS=ON -DCMAKE_BUILD_TYPE=Release
        make -j$(nproc)

    - name: Run GTest Unit Tests
      run: |
        cd build
        ctest --output-on-failure

    - name: Run Integration Tests
      run: |
        cd test/integration
        ./run_all_tests.sh

    - name: Upload test artifacts on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-outputs
        path: test/integration/*.output

  sanitizer-asan:
    name: AddressSanitizer
    runs-on: ubuntu-latest
    needs: check-build-success

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential clang default-jre

    - name: Configure with ASan
      run: |
        mkdir build-asan
        cd build-asan
        cmake .. -DBUILD_TESTS=ON \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_CXX_FLAGS="-fsanitize=address -fno-omit-frame-pointer -g" \
          -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address"

    - name: Build with ASan
      run: |
        cd build-asan
        make -j$(nproc)

    - name: Run GTest with ASan
      run: |
        cd build-asan
        ASAN_OPTIONS=detect_leaks=1:halt_on_error=1 ctest --output-on-failure

    - name: Run Integration Tests with ASan
      run: |
        cd test/integration
        ASAN_OPTIONS=detect_leaks=1:halt_on_error=1 ../../build-asan/btft < echo_basic.input > /dev/null || true

  sanitizer-ubsan:
    name: UndefinedBehaviorSanitizer
    runs-on: ubuntu-latest
    needs: check-build-success

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential clang default-jre

    - name: Configure with UBSan
      run: |
        mkdir build-ubsan
        cd build-ubsan
        cmake .. -DBUILD_TESTS=ON \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_CXX_FLAGS="-fsanitize=undefined -fno-omit-frame-pointer -g" \
          -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=undefined"

    - name: Build with UBSan
      run: |
        cd build-ubsan
        make -j$(nproc)

    - name: Run GTest with UBSan
      run: |
        cd build-ubsan
        UBSAN_OPTIONS=halt_on_error=1:print_stacktrace=1 ctest --output-on-failure

    - name: Run Integration Tests with UBSan
      run: |
        cd test/integration
        UBSAN_OPTIONS=halt_on_error=1:print_stacktrace=1 ../../build-ubsan/btft < echo_basic.input > /dev/null || true

  sanitizer-tsan:
    name: ThreadSanitizer
    runs-on: ubuntu-latest
    needs: check-build-success

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential clang default-jre

    - name: Configure with TSan
      run: |
        mkdir build-tsan
        cd build-tsan
        cmake .. -DBUILD_TESTS=ON \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_CXX_FLAGS="-fsanitize=thread -fno-omit-frame-pointer -g" \
          -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=thread"

    - name: Build with TSan
      run: |
        cd build-tsan
        make -j$(nproc)

    - name: Run GTest with TSan
      run: |
        cd build-tsan
        TSAN_OPTIONS=halt_on_error=1:second_deadlock_stack=1 ctest --output-on-failure

    - name: Run Integration Tests with TSan
      run: |
        cd test/integration
        TSAN_OPTIONS=halt_on_error=1:second_deadlock_stack=1 ../../build-tsan/btft < echo_basic.input > /dev/null || true
