name: Unified CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  linters:
    name: Linters
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format-15
        find src tests -name '*.cpp' -o -name '*.hpp' -o -name '*.h' -o -name '*.c' | \
          xargs clang-format-15 --dry-run -Werror -style=file
        
    - name: Run clang-tidy
      run: |
        sudo apt-get install -y clang-tidy-15
        find src tests -name '*.cpp' -o -name '*.c' | \
          xargs -I {} clang-tidy-15 {} || true

  build-ubuntu:
    name: Build on Ubuntu
    runs-on: ubuntu-latest
    needs: linters
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      
    - name: Build
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake
        cmake -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build

  build-windows:
    name: Build on Windows
    runs-on: windows-latest
    needs: linters
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      
    - name: Build
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64
        cmake --build build --config Release

  build-macos:
    name: Build on macOS
    runs-on: macos-latest
    needs: linters
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      
    - name: Build
      run: |
        brew install cmake
        cmake -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [build-ubuntu, build-windows, build-macos]
    
    steps:
    - name: Run tests
      run: |
        echo "There is not tests yet"
