name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  linters:
    name: Linters
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format-15
        find src include -name '*.cpp' -o -name '*.hpp' -o -name '*.h' -o -name '*.c' | \
          xargs clang-format-15 --dry-run -Werror -style=file

    - name: Run clang-tidy
      run: |
        sudo apt-get install -y clang-tidy-15
        find src -name '*.cpp' -o -name '*.c' | \
          xargs -I {} clang-tidy-15 {} || true

  build-ubuntu:
    name: Build on Ubuntu
    runs-on: ubuntu-latest
    needs: linters

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake default-jre

    - name: Build
      run: |
        cmake -B build -DBUILD_TESTS=ON -DCMAKE_BUILD_TYPE=Release
        cmake --build build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-ubuntu
        path: |
          build/
          test/
        retention-days: 1

  # build-windows:
  #   name: Build on Windows
  #   runs-on: windows-latest
  #   needs: linters

  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v6

  #   - name: Build
  #     run: |
  #       cmake -B build -G "Visual Studio 17 2022" -A x64
  #       cmake --build build --config Release

  build-macos:
    name: Build on macOS
    runs-on: macos-latest
    needs: linters

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Build
      run: |
        brew install cmake
        cmake -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build-ubuntu

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-ubuntu

    - name: Install runtime dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y default-jre

    - name: Make binaries executable
      run: chmod +x build/btft

    # - name: Run GTest Unit Tests
    #   run: |
    #     cd build
    #     ctest --output-on-failure

    - name: Run Integration Tests
      run: |
        cd test/integration
        ./run_all_tests.sh
